<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Резюме — Конструктор</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Шрифт -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --page-width: 210mm;
      --page-height: 297mm;

      --font-main: "Manrope", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, Arial, sans-serif;
      --font-size-base: 13px;
      --line-height-base: 1.35;

      --color-bg: #e5e7eb;
      --color-panel-bg: #f9fafb;
      --color-border-subtle: #e5e7eb;
      --color-text-main: #111827;
      --color-text-muted: #4b5563;
      --color-primary: #111827;
      --color-primary-strong: #020617;
      --color-accent: #1d4ed8;
    }

    * {
      box-sizing: border-box;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    @page {
      size: A4;
      margin: 0;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: var(--font-main);
      font-size: var(--font-size-base);
      background: radial-gradient(circle at top, #f9fafb 0, var(--color-bg) 45%, #d1d5db 100%);
      overflow-y: auto;
      word-spacing: 0.06em;
      font-weight: 500;
    }

    body {
      color: var(--color-text-main);
    }

    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    /* Фиксированная ширина макета, будем масштабировать через JS */
    .app-inner {
      width: 1240px;
      max-width: 1240px;
      display: flex;
      gap: 24px;
      align-items: flex-start;
      margin: 0 auto;
      transform-origin: top left;
    }

    /* Левая панель */

    .controls {
      width: 280px;
      font-size: 14px;
      color: var(--color-text-main);
      max-height: calc(100vh - 48px);
      overflow-y: auto;
      background: var(--color-panel-bg);
      border-radius: 14px;
      border: 1px solid var(--color-border-subtle);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
      padding: 16px 16px 18px;
      position: sticky;
      top: 24px;
    }

    .controls h1 {
      font-size: 20px;
      font-weight: 700;
      margin: 0 0 6px 0;
    }

    .controls p {
      margin: 0 0 12px 0;
      line-height: 1.4;
      font-weight: 500;
      color: var(--color-text-muted);
    }

    .button-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 9px 16px;
      border-radius: 9999px;
      border: none;
      background: var(--color-primary);
      color: #f9fafb;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.1s ease,
        box-shadow 0.15s ease;
      box-shadow: 0 6px 12px rgba(15, 23, 42, 0.18);
    }

    .button-primary:hover {
      background: var(--color-primary-strong);
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.28);
    }

    .button-primary:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2);
    }

    .hint {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: 8px;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .field-group {
      margin-bottom: 10px;
    }

    .field-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--color-text-main);
    }

    .help-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 9999px;
      border: 1px solid #d1d5db;
      font-size: 11px;
      cursor: default;
      color: var(--color-text-muted);
      margin-left: 6px;
      background: #ffffff;
    }

    .field-input,
    .field-textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 13px;
      padding: 7px 9px;
      resize: vertical;
      line-height: 1.4;
      font-weight: 500;
      background: #ffffff;
      transition: border-color 0.15s ease, box-shadow 0.15s ease,
        background-color 0.15s ease;
    }

    .field-input:focus,
    .field-textarea:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.25);
      background: #fefefe;
    }

    .field-textarea {
      min-height: 56px;
    }

    .edu-control-item,
    .job-control-item {
      border-radius: 10px;
      border: 1px dashed #e5e7eb;
      padding: 6px 8px;
      margin-bottom: 10px;
      background: #ffffff;
    }

    .accordion {
      border-radius: 12px;
      border: 1px solid var(--color-border-subtle);
      padding: 4px 10px;
      margin-top: 10px;
      margin-bottom: 8px;
      background: #f3f4f6;
    }

    .accordion > summary {
      list-style: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 2px;
      color: var(--color-text-main);
    }

    .accordion > summary::-webkit-details-marker {
      display: none;
    }

    .accordion[open] > summary {
      border-bottom: 1px dashed #d1d5db;
      margin-bottom: 4px;
    }

    .accordion-arrow {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-left: 8px;
      transition: transform 0.15s ease;
    }

    .accordion[open] .accordion-arrow {
      transform: rotate(180deg);
    }

    .accordion-body {
      margin-top: 4px;
      padding-top: 4px;
    }

    .page-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      max-height: calc(100vh - 48px);
      overflow-y: auto;
    }

    /* Страница A4 */

    #resume-page {
      width: var(--page-width);
      height: var(--page-height);
      background: #ffffff;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.35);
      display: flex;
      overflow: hidden;
      border-radius: 4px;
    }

    /* Чёрная колонка */

    .sidebar {
      width: 72mm;
      background: #000000;
      color: #f9fafb;
      padding: 2mm 2mm 2mm 2mm;
      display: flex;
      flex-direction: column;
    }

    .photo-block {
      width: 100%;
      margin-top: 8mm;
      margin-bottom: 6mm;
      position: relative;
    }

    #profile-photo {
      width: 100%;
      height: auto;
      max-height: 140mm;
      object-fit: contain;
      display: block;
      cursor: pointer;
      background: #111111;
      border-radius: 6px;
    }

    .upload-button {
      margin-top: 4px;
      padding: 4px 10px;
      border-radius: 9999px;
      border: 1px solid #e5e7eb;
      background: transparent;
      color: #f9fafb;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .upload-button:hover {
      background: rgba(249, 250, 251, 0.06);
      border-color: #f9fafb;
    }

    .sidebar-section,
    .sidebar-title-row {
      padding-left: 3mm;
      padding-right: 3mm;
    }

    .sidebar-section {
      margin-bottom: 5mm;
      font-size: 11pt;
      line-height: var(--line-height-base);
      font-weight: 500;
    }

    .sidebar-title-row {
      position: relative; /* ВАЖНО: привязываем плюс к строке, а не к странице */
      display: flex;
      align-items: center;
    }

    .sidebar-title {
      font-size: 12pt;
      letter-spacing: 0.23em;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 1.5mm;
    }

    .sidebar-text,
    .sidebar-langs,
    .sidebar-education-item {
      font-size: 11pt;
      line-height: var(--line-height-base);
      font-weight: 500;
    }

    .sidebar-education-item {
      margin-bottom: 2.5mm;
      position: relative;
    }

    .sidebar-year {
      font-weight: 700;
      font-size: 11pt;
      margin-bottom: 1mm;
    }

    /* Белая колонка */

    .main-column {
      flex: 1;
      padding: 3mm 3mm 3mm 3mm;
      color: var(--color-text-main);
      display: flex;
      flex-direction: column;
    }

    .name {
      font-size: 28pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin: 0 0 4mm 1mm;
      line-height: 1.2;
    }

    .experience-header-row {
      position: relative;
      padding-right: 16px;
      margin-bottom: 5mm;
      margin-left: 1mm;
      margin-right: 2mm;
      display: flex;
      align-items: center;
    }

    .experience-title {
      font-size: 12pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.28em;
      color: var(--color-accent);
      margin: 0;
    }

    .jobs-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .job-block {
      font-size: 11pt;
      line-height: 1.4;
      margin-bottom: 4mm;
      position: relative;
      font-weight: 500;
    }

    .job-period {
      font-weight: 700;
      margin-bottom: 1mm;
    }

    .job-company {
      font-weight: 700;
      text-transform: none;
      margin-bottom: 1mm;
    }

    .job-text {
      margin-bottom: 1mm;
    }

    .job-duties-title {
      font-weight: 700;
      margin-bottom: 1mm;
      font-size: 11pt;
    }

    .job-list {
      margin: 0 0 0 3mm;
      padding: 0;
    }

    .job-list li {
      margin-bottom: 0.6mm;
    }

    /* Кнопки + / − */

    .edit-icon {
      border-radius: 50%;
      width: 13px;
      height: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      line-height: 1;
      border: 1px solid currentColor;
      background: rgba(255, 255, 255, 0.9);
      padding: 0;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.15s ease, transform 0.1s ease,
        box-shadow 0.15s ease;
      box-shadow: 0 2px 4px rgba(15, 23, 42, 0.25);
    }

    .edit-icon--light {
      color: #f9fafb;
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .edit-icon--dark {
      color: #4b5563;
    }

    .edit-icon:hover {
      transform: translateY(-0.5px);
      background: #ffffff;
    }

    .edit-add-edu,
    .edit-add-job {
      position: absolute;
      right: 0;        /* прижимаем к правому краю строки */
      top: 50%;
      transform: translateY(-50%);
      z-index: 5;
    }

    /* Минусы — аккуратно левее и чуть ниже центра строки */
    .edit-remove-edu {
      position: absolute;
      left: -5mm;
      top: 1mm;
    }

    .edit-remove-job {
      position: absolute;
      left: -5mm;
      top: 1mm;
    }

    .no-print {
      /* скрываем в печати */
    }

    [contenteditable="true"] {
      outline: 1px dashed transparent;
      transition: outline-color 0.15s ease, background-color 0.15s ease;
      font-weight: 500;
    }

    [contenteditable="true"]:hover {
      outline-color: rgba(148, 163, 184, 0.7);
    }

    [contenteditable="true"]:focus {
      outline-color: #fbbf24;
      background: rgba(248, 250, 252, 0.8);
    }

    /* На мобильных только уменьшаем внешние отступы, макет остаётся тот же.
       Масштаб регулируется JS через transform. */
    @media (max-width: 1024px) {
      .app {
        padding: 16px;
      }
    }

    @media print {
      html,
      body {
        margin: 0 !important;
        padding: 0 !important;
        height: auto !important;
        overflow: visible !important;
        background: #ffffff !important;
      }
      .app {
        padding: 0 !important;
        min-height: 0 !important;
      }
      .controls {
        display: none !important;
      }
      .page-wrapper {
        max-height: none !important;
        overflow: visible !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      .app-inner {
        transform: none !important;
        width: 1240px !important;
      }
      #resume-page {
        box-shadow: none !important;
        margin: 0 !important;
        width: var(--page-width) !important;
        height: var(--page-height) !important;
        border-radius: 0 !important;
      }
      .no-print,
      .edit-icon {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-inner">
      <!-- Панель управления -->
      <aside class="controls">
        <h1>Редактор резюме</h1>
        <p>
          1. Заполни поля ниже или редактируй текст прямо в резюме.<br />
          2. Кликни по фото или по кнопке, чтобы загрузить своё.<br />
          3. Нажми «Скачать PDF» — получишь 1 страницу A4.
        </p>
        <button class="button-primary" id="download-pdf">Скачать PDF</button>
        <div class="hint">
          Многострочные поля: каждая строка = новая строка или новый пункт списка.
        </div>

        <details class="accordion" open>
          <summary>
            <span>Общие</span>
            <span class="accordion-arrow">▾</span>
          </summary>
          <div class="accordion-body">
            <div class="field-group">
              <div class="field-label">
                <span>Имя</span>
                <span class="help-icon" title="Крупный заголовок в правой колонке.">?</span>
              </div>
              <input id="input-name" class="field-input" type="text" />
            </div>
          </div>
        </details>

        <details class="accordion">
          <summary>
            <span>Контакты</span>
            <span class="accordion-arrow">▾</span>
          </summary>
          <div class="accordion-body">
            <div class="field-group">
              <div class="field-label">
                <span>Город</span>
                <span class="help-icon" title="Первая строка блока контактов.">?</span>
              </div>
              <input id="input-city" class="field-input" type="text" />
            </div>
            <div class="field-group">
              <div class="field-label">
                <span>Email</span>
                <span class="help-icon" title="Вторая строка блока контактов.">?</span>
              </div>
              <input id="input-email" class="field-input" type="text" />
            </div>
            <div class="field-group">
              <div class="field-label">
                <span>Телефон</span>
                <span class="help-icon" title="Третья строка блока контактов.">?</span>
              </div>
              <input id="input-phone" class="field-input" type="text" />
            </div>
            <div class="field-group">
              <div class="field-label">
                <span>Telegram</span>
                <span class="help-icon" title="Четвёртая строка блока контактов.">?</span>
              </div>
              <input id="input-tg" class="field-input" type="text" />
            </div>
          </div>
        </details>

        <details class="accordion">
          <summary>
            <span>Языки</span>
            <span class="accordion-arrow">▾</span>
          </summary>
          <div class="accordion-body">
            <div class="field-group">
              <div class="field-label">
                <span>Список языков</span>
                <span class="help-icon" title="Каждая строка — новый язык.">?</span>
              </div>
              <textarea id="input-langs" class="field-textarea"></textarea>
            </div>
          </div>
        </details>

        <details class="accordion">
          <summary>
            <span>Образование</span>
            <span class="accordion-arrow">▾</span>
          </summary>
          <div class="accordion-body">
            <div id="edu-controls-list"></div>
          </div>
        </details>

        <details class="accordion">
          <summary>
            <span>Опыт работы</span>
            <span class="accordion-arrow">▾</span>
          </summary>
          <div class="accordion-body">
            <div id="job-controls-list"></div>
          </div>
        </details>
      </aside>

      <!-- Страница резюме -->
      <div class="page-wrapper">
        <div id="resume-page">
          <!-- Чёрная колонка -->
          <aside class="sidebar">
            <div class="photo-block">
              <img
                id="profile-photo"
                src="https://via.placeholder.com/600x800.png?text=%D0%A4%D0%BE%D1%82%D0%BE"
                alt="Фото"
              />
              <input
                type="file"
                id="photo-input"
                accept="image/*"
                style="display:none"
              />
              <button id="upload-btn" class="upload-button no-print" type="button">
                Загрузить фото
              </button>
            </div>

            <div class="sidebar-section">
              <div id="city-text" contenteditable="true">Москва</div>
              <div id="email-text" contenteditable="true">ekaterina.sukhareva@bk</div>
              <div id="phone-text" contenteditable="true">+7 917 124 77 00</div>
              <div id="tg-text" contenteditable="true">ТГ: beluory</div>
            </div>

            <div class="sidebar-section">
              <div class="sidebar-title">ЯЗЫКИ</div>
              <div id="langs-text" class="sidebar-langs" contenteditable="true">
                Английский B2<br />
                Испанский A2
              </div>
            </div>

            <div class="sidebar-section">
              <div class="sidebar-title-row">
                <div class="sidebar-title">ОБРАЗОВАНИЕ</div>
                <button type="button" class="edit-icon edit-icon--light edit-add-edu no-print">+</button>
              </div>

              <div id="education-list">
                <div class="sidebar-education-item">
                  <button type="button" class="edit-icon edit-icon--light edit-remove-edu no-print">−</button>
                  <div class="sidebar-year" contenteditable="true">2019–2023</div>
                  <div class="sidebar-text" contenteditable="true">
                    Национальный исследовательский университет
                    «Высшая школа экономики», Москва<br />
                    Факультет мировой экономики и мировой политики,<br />
                    Международные отношения (бакалавр международных отношений)
                  </div>
                </div>

                <div class="sidebar-education-item">
                  <button type="button" class="edit-icon edit-icon--light edit-remove-edu no-print">−</button>
                  <div class="sidebar-year" contenteditable="true">2023–2024</div>
                  <div class="sidebar-text" contenteditable="true">
                    Медиа институт телевидения и радиовещания Останкино<br />
                    Тележурналистика, Теле/радио ведущий
                  </div>
                </div>
              </div>
            </div>
          </aside>

          <!-- Белая колонка -->
          <main class="main-column">
            <div id="name-text" class="name" contenteditable="true">
              Екатерина Сухарева
            </div>

            <div class="experience-header-row">
              <div class="experience-title">
                ОПЫТ РАБОТЫ
              </div>
              <button type="button" class="edit-icon edit-icon--dark edit-add-job no-print">+</button>
            </div>

            <div class="jobs-container" id="jobs-container">
              <section class="job-block">
                <button type="button" class="edit-icon edit-icon--dark edit-remove-job no-print">−</button>
                <div class="job-period" contenteditable="true">
                  Март 2022 – ноябрь 2023
                </div>
                <div class="job-company" contenteditable="true">
                  ООО «ГСХ», ивент-менеджер
                </div>
                <div class="job-text" contenteditable="true">
                  Организация международных бизнес-мероприятий для российских
                  производителей, включая выставочные стенды и бизнес-миссии.
                </div>
                <div class="job-duties-title">
                  Обязанности:
                </div>
                <ul class="job-list" contenteditable="true">
                  <li>ведение клиента на всех этапах подготовки проекта;</li>
                  <li>управление логистикой и проживанием всех участников;</li>
                  <li>дизайн каталогов, стендов, промо-продукции;</li>
                  <li>составление маркетинговых презентаций;</li>
                  <li>ведение бюджета.</li>
                </ul>
              </section>

              <section class="job-block">
                <button type="button" class="edit-icon edit-icon--dark edit-remove-job no-print">−</button>
                <div class="job-period" contenteditable="true">
                  Ноябрь 2023 – июль 2024
                </div>
                <div class="job-company" contenteditable="true">
                  М-продакшн, редактор, сценарист
                </div>
                <div class="job-text" contenteditable="true">
                  Создание и выпуск передач на федеральные каналы (Россия 1, НТВ,
                  МУЗ ТВ, ТВ-3).
                </div>
                <div class="job-duties-title">
                  Обязанности:
                </div>
                <ul class="job-list" contenteditable="true">
                  <li>разработка актуальных тем;</li>
                  <li>привлечение спикеров;</li>
                  <li>написание сценариев;</li>
                  <li>координация создания интерактивного реквизита и декораций.</li>
                </ul>
              </section>

              <section class="job-block">
                <button type="button" class="edit-icon edit-icon--dark edit-remove-job no-print">−</button>
                <div class="job-period" contenteditable="true">
                  Сентябрь 2024 – май 2025
                </div>
                <div class="job-company" contenteditable="true">
                  Москва Медиа, телеведущая
                </div>
                <div class="job-duties-title">
                  Обязанности:
                </div>
                <ul class="job-list" contenteditable="true">
                  <li>работа в кадре в качестве ведущей;</li>
                  <li>координация работы команды на площадке;</li>
                  <li>подготовка материалов и написание сюжетов для программ.</li>
                </ul>
              </section>

              <section class="job-block">
                <button type="button" class="edit-icon edit-icon--dark edit-remove-job no-print">−</button>
                <div class="job-period" contenteditable="true">
                  Октябрь 2024 – настоящее время
                </div>
                <div class="job-company" contenteditable="true">
                  Фриланс, Креативный продюсер
                </div>
                <div class="job-text" contenteditable="true">
                  Полное управление циклом производства видеоконтента: от разработки
                  концепции до сдачи финального продукта.
                </div>
                <div class="job-duties-title">
                  Обязанности:
                </div>
                <ul class="job-list" contenteditable="true">
                  <li>создание креативов под задачи проекта;</li>
                  <li>координация работы подрядчиков на съёмочной площадке;</li>
                  <li>подбор локации;</li>
                  <li>управление визуальной реализацией дизайна локации;</li>
                  <li>подбор реквизита;</li>
                  <li>ведение бюджета.</li>
                </ul>
              </section>
            </div>
          </main>
        </div>
      </div>
    </div>
  </div>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
    integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const resumePage = document.getElementById("resume-page");
      const downloadBtn = document.getElementById("download-pdf");
      const appInner = document.querySelector(".app-inner");

      const photo = document.getElementById("profile-photo");
      const photoInput = document.getElementById("photo-input");
      const uploadBtn = document.getElementById("upload-btn");

      /* Масштабирование всего макета под ширину экрана (для мобилки) */
      function applyScale() {
        if (!appInner) return;
        const designWidth = 1240; // как в CSS
        const vw = window.innerWidth;

        if (vw >= designWidth) {
          appInner.style.transform = "";
          appInner.style.width = designWidth + "px";
          return;
        }

        const scale = vw / designWidth;
        appInner.style.transform = "scale(" + scale + ")";
        appInner.style.width = designWidth + "px";
      }

      applyScale();
      window.addEventListener("resize", applyScale);

      /* Загрузка фото */

      function triggerPhotoInput() {
        if (!photoInput) return;
        photoInput.value = "";
        photoInput.click();
      }

      if (photo && uploadBtn && photoInput) {
        photo.addEventListener("click", triggerPhotoInput);
        uploadBtn.addEventListener("click", triggerPhotoInput);

        photoInput.addEventListener("change", function (event) {
          const file = event.target.files && event.target.files[0];
          if (!file) return;
          if (!file.type.startsWith("image/")) {
            alert("Пожалуйста, выберите файл изображения.");
            return;
          }
          const reader = new FileReader();
          reader.onload = function (e) {
            photo.src = e.target.result;
            uploadBtn.style.display = "none";
          };
          reader.readAsDataURL(file);
        });
      }

      /* Двусторонняя привязка полей */

      function bindBidirectionalText(inputId, elementId) {
        const input = document.getElementById(inputId);
        const el = document.getElementById(elementId);
        if (!input || !el) return;

        const syncFromEl = () => {
          input.value = el.textContent.trim();
        };
        const syncFromInput = () => {
          el.textContent = input.value;
        };

        syncFromEl();
        input.addEventListener("input", syncFromInput);
        el.addEventListener("input", syncFromEl);
        el.addEventListener("blur", syncFromEl);
      }

      function bindBidirectionalMultiline(inputId, elementId) {
        const input = document.getElementById(inputId);
        const el = document.getElementById(elementId);
        if (!input || !el) return;

        const syncFromEl = () => {
          input.value = el.innerText.replace(/\u00a0/g, " ").trim();
        };

        const syncFromInput = () => {
          const lines = input.value.split(/\r?\n/);
          const html = lines
            .map(l => l.trim())
            .filter(l => l.length > 0)
            .join("<br />");
          el.innerHTML = html || "";
        };

        syncFromEl();
        input.addEventListener("input", syncFromInput);
        el.addEventListener("input", syncFromEl);
        el.addEventListener("blur", syncFromEl);
      }

      bindBidirectionalText("input-name", "name-text");
      bindBidirectionalText("input-city", "city-text");
      bindBidirectionalText("input-email", "email-text");
      bindBidirectionalText("input-phone", "phone-text");
      bindBidirectionalText("input-tg", "tg-text");
      bindBidirectionalMultiline("input-langs", "langs-text");

      /* Образование */

      function buildEduControls() {
        const educationList = document.getElementById("education-list");
        const controlsList = document.getElementById("edu-controls-list");
        if (!educationList || !controlsList) return;

        const eduItems = Array.from(
          educationList.querySelectorAll(".sidebar-education-item")
        );
        controlsList.innerHTML = "";

        eduItems.forEach((item, index) => {
          item.dataset.eduIndex = String(index);
          const yearEl = item.querySelector(".sidebar-year");
          const textEl = item.querySelector(".sidebar-text");

          const control = document.createElement("div");
          control.className = "edu-control-item";
          control.dataset.eduIndex = String(index);
          control.innerHTML = `
            <div class="field-group">
              <div class="field-label"><span>Годы ${index + 1}</span></div>
              <input type="text" class="field-input edu-year-input" />
            </div>
            <div class="field-group">
              <div class="field-label"><span>Текст ${index + 1}</span></div>
              <textarea class="field-textarea edu-text-input"></textarea>
            </div>
          `;

          const yearInput = control.querySelector(".edu-year-input");
          const textInput = control.querySelector(".edu-text-input");

          if (yearInput && yearEl) yearInput.value = yearEl.textContent.trim();
          if (textInput && textEl)
            textInput.value = textEl.innerText.replace(/\u00a0/g, " ").trim();

          if (yearInput && yearEl) {
            yearInput.addEventListener("input", () => {
              yearEl.textContent = yearInput.value;
            });
            yearEl.oninput = () => {
              yearInput.value = yearEl.textContent.trim();
            };
            yearEl.onblur = yearEl.oninput;
          }

          if (textInput && textEl) {
            const applyTextareaToPreview = () => {
              const lines = textInput.value
                .split(/\r?\n/)
                .map(l => l.trim())
                .filter(l => l);
              textEl.innerHTML = lines.join("<br />");
            };
            textInput.addEventListener("input", applyTextareaToPreview);

            const syncFromPreview = () => {
              textInput.value = textEl.innerText.replace(/\u00a0/g, " ").trim();
            };
            textEl.oninput = syncFromPreview;
            textEl.onblur = syncFromPreview;
          }

          controlsList.appendChild(control);
        });
      }

      const educationList = document.getElementById("education-list");
      const addEduBtn = document.querySelector(".edit-add-edu");

      if (educationList && addEduBtn) {
        addEduBtn.addEventListener("click", () => {
          const template = educationList.querySelector(
            ".sidebar-education-item:last-of-type"
          );
          if (!template) return;

          const clone = template.cloneNode(true);

          const yearEl = clone.querySelector(".sidebar-year");
          const textEl = clone.querySelector(".sidebar-text");
          if (yearEl) yearEl.textContent = "Годы обучения";
          if (textEl) {
            textEl.innerHTML =
              "Название учебного заведения<br />Факультет / специальность";
          }

          educationList.appendChild(clone);
          buildEduControls();
        });

        educationList.addEventListener("click", event => {
          const btn = event.target.closest(".edit-remove-edu");
          if (!btn) return;
          const item = btn.closest(".sidebar-education-item");
          if (!item) return;

          if (
            educationList.querySelectorAll(".sidebar-education-item").length <= 1
          )
            return;
          item.remove();
          buildEduControls();
        });
      }

      /* Опыт */

      function buildJobControls() {
        const jobsContainer = document.getElementById("jobs-container");
        const controlsList = document.getElementById("job-controls-list");
        if (!jobsContainer || !controlsList) return;

        const jobBlocks = Array.from(
          jobsContainer.querySelectorAll(".job-block")
        );
        controlsList.innerHTML = "";

        jobBlocks.forEach((block, index) => {
          block.dataset.jobIndex = String(index);
          const periodEl = block.querySelector(".job-period");
          const companyEl = block.querySelector(".job-company");
          const textEl = block.querySelector(".job-text");
          const listEl = block.querySelector(".job-list");

          const control = document.createElement("div");
          control.className = "job-control-item";
          control.dataset.jobIndex = String(index);
          control.innerHTML = `
            <div class="field-group">
              <div class="field-label"><span>Период ${index + 1}</span></div>
              <input type="text" class="field-input job-period-input" />
            </div>
            <div class="field-group">
              <div class="field-label"><span>Компания и роль ${index + 1}</span></div>
              <input type="text" class="field-input job-company-input" />
            </div>
            <div class="field-group">
              <div class="field-label"><span>Описание ${index + 1}</span></div>
              <textarea class="field-textarea job-text-input"></textarea>
            </div>
            <div class="field-group">
              <div class="field-label"><span>Обязанности ${index + 1}</span></div>
              <textarea class="field-textarea job-list-input"></textarea>
            </div>
          `;

          const periodInput = control.querySelector(".job-period-input");
          const companyInput = control.querySelector(".job-company-input");
          const textInput = control.querySelector(".job-text-input");
          const listInput = control.querySelector(".job-list-input");

          if (periodInput && periodEl)
            periodInput.value = periodEl.textContent.trim();
          if (companyInput && companyEl)
            companyInput.value = companyEl.textContent.trim();
          if (textInput) {
            if (textEl) {
              textInput.value = textEl.innerText.replace(/\u00a0/g, " ").trim();
            } else {
              textInput.value = "";
              const fg = textInput.closest(".field-group");
              if (fg) fg.style.display = "none";
            }
          }
          if (listInput && listEl) {
            const items = Array.from(listEl.querySelectorAll("li")).map(li =>
              li.textContent.trim()
            );
            listInput.value = items.join("\n");
          }

          if (periodInput && periodEl) {
            periodInput.addEventListener("input", () => {
              periodEl.textContent = periodInput.value;
            });
            periodEl.oninput = () => {
              periodInput.value = periodEl.textContent.trim();
            };
            periodEl.onblur = periodEl.oninput;
          }

          if (companyInput && companyEl) {
            companyInput.addEventListener("input", () => {
              companyEl.textContent = companyInput.value;
            });
            companyEl.oninput = () => {
              companyInput.value = companyEl.textContent.trim();
            };
            companyEl.onblur = companyEl.oninput;
          }

          if (textInput && textEl) {
            const applyTextInput = () => {
              const lines = textInput.value
                .split(/\r?\n/)
                .map(l => l.trim())
                .filter(l => l);
              textEl.innerHTML = lines.join("<br />");
            };
            textInput.addEventListener("input", applyTextInput);
            const syncFromPreview = () => {
              textInput.value = textEl.innerText.replace(/\u00a0/g, " ").trim();
            };
            textEl.oninput = syncFromPreview;
            textEl.onblur = syncFromPreview;
          }

          if (listInput && listEl) {
            const applyListInput = () => {
              const lines = listInput.value
                .split(/\r?\n/)
                .map(l => l.trim())
                .filter(l => l);
              listEl.innerHTML = "";
              lines.forEach(line => {
                const li = document.createElement("li");
                li.textContent = line;
                listEl.appendChild(li);
              });
            };
            listInput.addEventListener("input", applyListInput);

            const syncFromList = () => {
              const items = Array.from(listEl.querySelectorAll("li")).map(li =>
                li.textContent.trim()
              );
              listInput.value = items.join("\n");
            };
            listEl.oninput = syncFromList;
            listEl.onblur = syncFromList;
          }

          controlsList.appendChild(control);
        });
      }

      const jobsContainer = document.getElementById("jobs-container");
      const addJobBtn = document.querySelector(".edit-add-job");

      if (jobsContainer && addJobBtn) {
        addJobBtn.addEventListener("click", () => {
          const template = jobsContainer.querySelector(".job-block:last-of-type");
          if (!template) return;

          const clone = template.cloneNode(true);

          const periodEl = clone.querySelector(".job-period");
          const companyEl = clone.querySelector(".job-company");
          const textEl = clone.querySelector(".job-text");
          const listEl = clone.querySelector(".job-list");

          if (periodEl) periodEl.textContent = "Период работы";
          if (companyEl) companyEl.textContent = "Компания, должность";
          if (textEl) textEl.textContent = "Краткое описание места работы.";
          if (listEl) {
            listEl.innerHTML = "<li>Основная обязанность</li>";
          }

          jobsContainer.appendChild(clone);
          buildJobControls();
        });

        jobsContainer.addEventListener("click", event => {
          const btn = event.target.closest(".edit-remove-job");
          if (!btn) return;
          const block = btn.closest(".job-block");
          if (!block) return;
          if (jobsContainer.querySelectorAll(".job-block").length <= 1) return;
          block.remove();
          buildJobControls();
        });
      }

      buildEduControls();
      buildJobControls();

      if (downloadBtn && resumePage) {
        downloadBtn.addEventListener("click", function () {
          const opt = {
            margin: [0, 0, 0, 0],
            filename: "resume.pdf",
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true },
            jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
            pagebreak: { mode: ["avoid-all"] }
          };

          const toHide = document.querySelectorAll(".edit-icon, .no-print");
          const prevDisplay = [];
          toHide.forEach((el, idx) => {
            prevDisplay[idx] = el.style.display;
            el.style.display = "none";
          });

          // временно убираем масштаб перед рендером PDF
          const prevTransform = appInner.style.transform;
          const prevWidth = appInner.style.width;
          appInner.style.transform = "";
          appInner.style.width = "1240px";

          html2pdf()
            .set(opt)
            .from(resumePage)
            .save()
            .then(() => {
              // возвращаем масштаб и элементы
              appInner.style.transform = prevTransform;
              appInner.style.width = prevWidth;

              toHide.forEach((el, idx) => {
                el.style.display = prevDisplay[idx] || "";
              });
            });
        });
      }
    });
  </script>
</body>
</html>
